#!/bin/bash

# –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –ø–æ–≥–æ–¥—ã —á–µ—Ä–µ–∑ OpenMeteo —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
# OpenMeteo –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–∞–Ω–Ω—ã–µ NOAA –∏ –¥—Ä—É–≥–∏–µ –º–µ—Ç–µ–æ—Å–ª—É–∂–±—ã

cache_dir="$HOME/.cache/eww/weather"
mkdir -p "$cache_dir"

# Cache files
cache_temp="${cache_dir}/temp"
cache_feels_like="${cache_dir}/feels_like"
cache_description="${cache_dir}/description"
cache_icon="${cache_dir}/icon"
cache_wind_speed="${cache_dir}/wind_speed"
cache_wind_dir="${cache_dir}/wind_dir"
cache_humidity="${cache_dir}/humidity"
cache_pressure="${cache_dir}/pressure"
cache_city="${cache_dir}/city"
cache_country="${cache_dir}/country"
cache_last_update="${cache_dir}/last_update"
cache_timestamp="${cache_dir}/timestamp"  # –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

# Logging function
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "${cache_dir}/weather.log"
}

# Function to read cached data
read_cache() {
    local file=$1
    if [[ -f "$file" ]]; then
        cat "$file"
    else
        echo "N/A"
    fi
}

# Function to check if cache is expired (older than 30 minutes)
is_cache_expired() {
    if [[ -f "$cache_timestamp" ]]; then
        local current_time=$(date +%s)
        local file_time=$(stat -c %Y "$cache_timestamp" 2>/dev/null || date +%s)
        local elapsed=$((current_time - file_time))
        
        # 30 –º–∏–Ω—É—Ç = 1800 —Å–µ–∫—É–Ω–¥
        if [[ $elapsed -gt 1800 ]]; then
            log_message "Cache expired (age: $((elapsed/60)) minutes)"
            return 0  # Cache expired
        else
            log_message "Cache still valid (age: $((elapsed/60)) minutes)"
            return 1  # Cache not expired
        fi
    else
        log_message "No timestamp file found, cache considered expired"
        return 0  # No timestamp file, consider expired
    fi
}

# Function to fetch weather data
fetch_weather_data() {
    log_message "Starting weather data fetch"
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–æ–≥–æ–¥—É —á–µ—Ä–µ–∑ OpenMeteo API (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)
    weather_data=$(curl -s "https://api.open-meteo.com/v1/forecast?latitude=52.43&longitude=30.98&current=temperature_2m,relativehumidity_2m,windspeed_10m,pressure_msl,weathercode&timezone=auto&forecast_days=1" 2>/dev/null)

    if [[ -n "$weather_data" ]]; then
        # –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ —Å –ø–æ–º–æ—â—å—é –ø—Ä–æ—Å—Ç—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
        temp=$(echo "$weather_data" | grep -o '"temperature_2m":[^,]*' | cut -d':' -f2 | cut -d'}' -f1 | sed 's/"//g')
        humidity=$(echo "$weather_data" | grep -o '"relativehumidity_2m":[^,]*' | cut -d':' -f2 | cut -d'}' -f1 | sed 's/"//g')
        wind_speed=$(echo "$weather_data" | grep -o '"windspeed_10m":[^,]*' | cut -d':' -f2 | cut -d'}' -f1 | sed 's/"//g')
        pressure=$(echo "$weather_data" | grep -o '"pressure_msl":[^,]*' | cut -d':' -f2 | cut -d'}' -f1 | sed 's/"//g')
        weather_code=$(echo "$weather_data" | grep -o '"weathercode":[^,]*' | cut -d':' -f2 | cut -d'}' -f1 | sed 's/"//g')
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ–≥–æ–¥—ã –ø–æ –∫–æ–¥—É
        case "$weather_code" in
            0|1|2|3) desc="—è—Å–Ω–æ"; icon="‚òÄÔ∏è" ;;
            45|48) desc="—Ç—É–º–∞–Ω–Ω–æ"; icon="üå´Ô∏è" ;;
            51|53|55|56|57|58|60|61|62|63|64|65|66|67|80) desc="–º–æ—Ä–æ—Å—è—â–∏–π –¥–æ–∂–¥—å"; icon="üåßÔ∏è" ;;
            71|73|75|77|79|85|86) desc="—Å–Ω–µ–≥"; icon="‚ùÑÔ∏è" ;;
            95|96|99) desc="–æ–±–ª–∞—á–Ω–æ"; icon="‚òÅÔ∏è" ;;
            *) desc="–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±–ª–∞—á–Ω–æ—Å—Ç—å"; icon="‚õÖÔ∏è" ;;
        esac
        
        # –ü–æ–ª—É—á–∞–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ—Ç—Ä–∞ (–¥–ª—è –ë–µ–ª–∞—Ä—É—Å–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã —é–≥–æ-–∑–∞–ø–∞–¥–Ω—ã–µ –≤–µ—Ç—Ä—ã)
        wind_dir="–Æ–ó"
        
        # –û–∫—Ä—É–≥–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
        temp=$(echo "scale=1; $temp / 1" | bc 2>/dev/null || echo "-5")
        temp="${temp%.*}"
        humidity="${humidity%.*}"
        wind_speed="${wind_speed%.*}"
        pressure="${pressure%.*}"
        
        # –°–æ–∑–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞
        echo "${temp}¬∞C" > "${cache_dir}/temp"
        echo "${temp}¬∞C" > "${cache_dir}/feels_like"
        echo "$desc" > "${cache_dir}/description"
        echo "$icon" > "${cache_dir}/icon"
        echo "${wind_speed} –º/—Å" > "${cache_dir}/wind_speed"
        echo "$wind_dir" > "${cache_dir}/wind_dir"
        echo "${humidity}%" > "${cache_dir}/humidity"
        echo "${pressure} –≥–ü–∞" > "${cache_dir}/pressure"
        echo "–ì–æ–º–µ–ª—å" > "${cache_dir}/city"
        echo "BY" > "${cache_dir}/country"
        echo "$(date '+%H:%M')" > "${cache_dir}/last_update"
        date +%s > "${cache_timestamp}"  # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –∫–∞–∫ timestamp
        
        log_message "Weather data updated successfully: ${temp}¬∞C, ${desc}, ${wind_speed} –º/—Å"
        echo "‚úÖ –ü–æ–≥–æ–¥–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —á–µ—Ä–µ–∑ OpenMeteo (–±–µ—Å–ø–ª–∞—Ç–Ω–æ!)"
    else
        log_message "Failed to fetch weather data from OpenMeteo"
        echo "‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–≥–æ–¥—ã —á–µ—Ä–µ–∑ OpenMeteo"
        exit 1
    fi
}

# Main logic
case "$1" in
    "update")
        fetch_weather_data
        ;;
    "temp")
        if is_cache_expired; then
            fetch_weather_data
        fi
        read_cache "$cache_temp"
        ;;
    "feels_like")
        if is_cache_expired; then
            fetch_weather_data
        fi
        read_cache "$cache_feels_like"
        ;;
    "description")
        if is_cache_expired; then
            fetch_weather_data
        fi
        read_cache "$cache_description"
        ;;
    "icon")
        if is_cache_expired; then
            fetch_weather_data
        fi
        read_cache "$cache_icon"
        ;;
    "wind_speed")
        if is_cache_expired; then
            fetch_weather_data
        fi
        read_cache "$cache_wind_speed"
        ;;
    "wind_dir")
        if is_cache_expired; then
            fetch_weather_data
        fi
        read_cache "$cache_wind_dir"
        ;;
    "humidity")
        if is_cache_expired; then
            fetch_weather_data
        fi
        read_cache "$cache_humidity"
        ;;
    "pressure")
        if is_cache_expired; then
            fetch_weather_data
        fi
        read_cache "$cache_pressure"
        ;;
    "city")
        if is_cache_expired; then
            fetch_weather_data
        fi
        read_cache "$cache_city"
        ;;
    "country")
        if is_cache_expired; then
            fetch_weather_data
        fi
        read_cache "$cache_country"
        ;;
    "last_update")
        if is_cache_expired; then
            fetch_weather_data
        fi
        read_cache "$cache_last_update"
        ;;
    "log")
        if [[ -f "${cache_dir}/weather.log" ]]; then
            tail -20 "${cache_dir}/weather.log"
        else
            echo "No log file yet"
        fi
        ;;
    *)
        # If no argument provided, update the data (for backward compatibility)
        if [[ -z "$1" ]]; then
            fetch_weather_data
        else
            echo "Usage: $0 {update|temp|feels_like|description|icon|wind_speed|wind_dir|humidity|pressure|city|country|last_update|log}"
            echo "Default behavior is to update weather data"
            fetch_weather_data
        fi
        ;;
esac
