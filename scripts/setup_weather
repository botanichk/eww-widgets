#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–º–æ—â–∏ –≤ –ø–æ–ª—É—á–µ–Ω–∏–∏ OpenWeatherMap API –∫–ª—é—á–∞
# –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –≤–∏–¥–∂–µ—Ç–∞ –ø–æ–≥–æ–¥—ã

echo "üå§Ô∏è  –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∏–¥–∂–µ—Ç–∞ –ø–æ–≥–æ–¥—ã EWW –¥–ª—è –ì–æ–º–µ–ª—è"
echo "============================================"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."

if ! command -v curl &> /dev/null; then
    echo "‚ùå curl –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ:"
    echo "   Ubuntu/Debian: sudo apt install curl"
    echo "   Arch Linux: sudo pacman -S curl"
    exit 1
fi

if ! command -v jq &> /dev/null; then
    echo "‚ùå jq –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ:"
    echo "   Ubuntu/Debian: sudo apt install jq"
    echo "   Arch Linux: sudo pacman -S jq"
    exit 1
fi

echo "‚úÖ –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
echo ""

# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø–æ–ª—É—á–µ–Ω–∏—é API –∫–ª—é—á–∞
echo "üîë –ü–æ–ª—É—á–µ–Ω–∏–µ API –∫–ª—é—á–∞ OpenWeatherMap:"
echo "=================================="
echo ""
echo "1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ —Å–∞–π—Ç: https://home.openweathermap.org/users/sign_up"
echo "2. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:"
echo "   - Username: –≤–∞—à –Ω–∏–∫–Ω–µ–π–º"
echo "   - Email: –≤–∞—à–∞ –ø–æ—á—Ç–∞"
echo "   - Password: –ø–∞—Ä–æ–ª—å"
echo "   - Confirm password: –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
echo "3. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–æ—á—Ç—É (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Ö–æ–¥—è—â–∏–µ)"
echo "4. –í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç: https://home.openweathermap.org/sign_in"
echo "5. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ API keys: https://home.openweathermap.org/api_keys"
echo "6. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ API –∫–ª—é—á (–æ–Ω –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫: a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6)"
echo ""

# –ó–∞–ø—Ä–æ—Å API –∫–ª—é—á–∞
echo "üìù –í–≤–µ–¥–∏—Ç–µ –≤–∞—à API –∫–ª—é—á:"
read -p "API –∫–ª—é—á: " api_key

if [ -z "$api_key" ]; then
    echo "‚ùå API –∫–ª—é—á –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ API –∫–ª—é—á–∞
if [ ${#api_key} -ne 32 ]; then
    echo "‚ö†Ô∏è  API –∫–ª—é—á –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 32 —Å–∏–º–≤–æ–ª–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –≤–≤–æ–¥–∞."
    echo "   –í–∞—à –∫–ª—é—á —Å–æ–¥–µ—Ä–∂–∏—Ç ${#api_key} —Å–∏–º–≤–æ–ª–æ–≤"
    read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å anyway? (y/N): " confirm
    if [[ $confirm != [yY] ]]; then
        exit 1
    fi
fi

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API –∫–ª—é—á–∞
echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API –∫–ª—é—á–∞..."
response=$(curl -s "http://api.openweathermap.org/data/2.5/weather?appid=${api_key}&q=Gomel,BY&units=metric&lang=ru" | jq -r '.cod')

if [ "$response" = "200" ]; then
    echo "‚úÖ API –∫–ª—é—á —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!"
else
    echo "‚ùå –û—à–∏–±–∫–∞ API –∫–ª—é—á–∞:"
    curl -s "http://api.openweathermap.org/data/2.5/weather?appid=${api_key}&q=Gomel,BY&units=metric&lang=ru" | jq -r '.message' 2>/dev/null
    echo ""
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:"
    echo "1. –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å API –∫–ª—é—á–∞"
    echo "2. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–∏ –ª–∏ –≤—ã –ø–æ—á—Ç—É"
    echo "3. –ù–µ –∏—Å—Ç–µ–∫ –ª–∏ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∫–ª—é—á–∞"
    exit 1
fi

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ weather_gomel
echo "‚öôÔ∏è  –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞ –ø–æ–≥–æ–¥—ã..."
script_path="$HOME/.config/eww/scripts/weather_gomel"

if [ ! -f "$script_path" ]; then
    echo "‚ùå –°–∫—Ä–∏–ø—Ç –ø–æ–≥–æ–¥—ã –Ω–µ –Ω–∞–π–¥–µ–Ω: $script_path"
    exit 1
fi

# –ó–∞–º–µ–Ω–∞ API –∫–ª—é—á–∞ –≤ —Å–∫—Ä–∏–ø—Ç–µ
sed -i "s/API_KEY=\"YOUR_API_KEY_HERE\"/API_KEY=\"$api_key\"/" "$script_path"

echo "‚úÖ API –∫–ª—é—á —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ —Å–∫—Ä–∏–ø—Ç –ø–æ–≥–æ–¥—ã"

# –ü–µ—Ä–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
echo "üîÑ –ü–µ—Ä–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–≥–æ–¥—ã..."
cd "$HOME/.config/eww"
./scripts/weather_gomel update

if [ $? -eq 0 ]; then
    echo "‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–≥–æ–¥—ã —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã"
    echo ""
    echo "üìä –¢–µ–∫—É—â–∞—è –ø–æ–≥–æ–¥–∞ –≤ –ì–æ–º–µ–ª–µ:"
    ./scripts/weather_gomel all
else
    echo "‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–≥–æ–¥—ã"
    exit 1
fi

echo ""
echo "üéâ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "üöÄ –î–ª—è –∑–∞–ø—É—Å–∫–∞ –≤–∏–¥–∂–µ—Ç–∞:"
echo "   eww daemon"
echo "   eww open weather"
echo ""
echo "üì± –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è –≤–µ—Ä—Å–∏—è:"
echo "   eww open weather-bar"
echo ""
echo "üîÑ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (—á–µ—Ä–µ–∑ cron):"
echo "   crontab -e"
echo "   –î–æ–±–∞–≤—å—Ç–µ —Å—Ç—Ä–æ–∫—É: */30 * * * * $HOME/.config/eww/scripts/weather_update"
echo ""