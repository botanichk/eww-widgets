#!/bin/bash

# –ü—É—Ç—å –∫ –∫—ç—à-—Ñ–∞–π–ª—É
CACHE_DIR="$HOME/.cache/eww/weather"
mkdir -p "$CACHE_DIR"
CACHE_FILE="$CACHE_DIR/current_weather"
CACHE_TIME=600  # 10 –º–∏–Ω—É—Ç

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
fetch_weather() {
    local json
    json=$(curl -s --max-time 10 "https://api.open-meteo.com/v1/forecast?latitude=52.4380&longitude=30.9900&current_weather=true")
    
    if [ $? -ne 0 ] || [[ -z "$json" ]] || [[ "$json" == *"error"* ]]; then
        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –≤ –∫—ç—à —Ñ–∞–π–ª
        echo '{"temp":"?", "icon":"üå§Ô∏è", "description":"–æ—à–∏–±–∫–∞", "feels_like":"?", "wind_speed":"?", "wind_dir":"?", "humidity":"?", "pressure":"?", "city":"–ì–æ–º–µ–ª—å", "country":"BY", "last_update":"?"}' > "$CACHE_FILE"
        return 1
    fi

    temp=$(echo "$json" | jq -r '.current_weather.temperature // empty')
    code=$(echo "$json" | jq -r '.current_weather.weathercode // empty')

    if [[ -z "$temp" ]] || [[ -z "$code" ]]; then
        echo '{"temp":"?", "icon":"üå§Ô∏è", "description":"–æ—à–∏–±–∫–∞", "feels_like":"?", "wind_speed":"?", "wind_dir":"?", "humidity":"?", "pressure":"?", "city":"–ì–æ–º–µ–ª—å", "country":"BY", "last_update":"?"}' > "$CACHE_FILE"
        return 1
    fi

    # –ò–∫–æ–Ω–∫–∏ –∏ –æ–ø–∏—Å–∞–Ω–∏—è –ø–æ –∫–æ–¥—É WMO
    case $code in
        0) icon="‚òÄÔ∏è"; desc="—è—Å–Ω–æ" ;;
        1|2|3) icon="‚õÖ"; desc="–º–∞–ª–æ–æ–±–ª–∞—á–Ω–æ" ;;
        45|48) icon="üå´Ô∏è"; desc="—Ç—É–º–∞–Ω" ;;
        51|53|55|56|57) icon="üåßÔ∏è"; desc="–º–æ—Ä–æ—Å—å" ;;
        61|63|65|66|67) icon="üåßÔ∏è"; desc="–¥–æ–∂–¥—å" ;;
        71|73|75|77) icon="‚ùÑÔ∏è"; desc="—Å–Ω–µ–≥" ;;
        80|81|82) icon="üå¶Ô∏è"; desc="–ª–∏–≤–µ–Ω—å" ;;
        85|86) icon="üå®Ô∏è"; desc="—Å–Ω–µ–≥ —Å –¥–æ–∂–¥–µ–º" ;;
        95|96|99) icon="‚õàÔ∏è"; desc="–≥—Ä–æ–∑–∞" ;;
        *) icon="üå§Ô∏è"; desc="–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±–ª–∞—á–Ω–æ—Å—Ç—å" ;;
    esac

    # –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    wind_speed=$(echo "$json" | jq -r '.current_weather.windspeed // empty')
    wind_direction=$(echo "$json" | jq -r '.current_weather.winddirection // empty')
    
    # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–µ—Ç—Ä–∞ –ø–æ –≥—Ä–∞–¥—É—Å–∞–º
    if [[ -n "$wind_direction" ]] && [[ "$wind_direction" != "null" ]]; then
        case $((wind_direction + 11)) in
            0|1|2|3|4|5|6|7|8|9|10|11|12|13|14|15|16|17|18|19|20|21|22|23|24|25|26|27|28|29|30|31|32|33|34|35|36|37|38|39|40|41|42|43|44|45|46|47|48|49|50|51|52|53|54|55|56|57|58|59|60|61|62|63|64|65|66|67|68|69|70|71|72|73|74|75|76|77|78|79|80|81|82|83|84|85|86|87|88|89|90|91|92|93|94|95|96|97|98|99|100|101|102|103|104|105|106|107|108|109|110|111|112|113|114|115|116|117|118|119|120|121|122|123|124|125|126|127|128|129|130|131|132|133|134|135|136|137|138|139|140|141|142|143|144|145|146|147|148|149|150|151|152|153|154|155|156|157|158|159|160|161|162|163|164|165|166|167|168|169|170|171|172|173|174|175|176|177|178|179|180|181|182|183|184|185|186|187|188|189|190|191|192|193|194|195|196|197|198|199|200|201|202|203|204|205|206|207|208|209|210|211|212|213|214|215|216|217|218|219|220|221|222|223|224|225|226|227|228|229|230|231|232|233|234|235|236|237|238|239|240|241|242|243|244|245|246|247|248|249|250|251|252|253|254|255|256|257|258|259|260|261|262|263|264|265|266|267|268|269|270|271|272|273|274|275|276|277|278|279|280|281|282|283|284|285|286|287|288|289|290|291|292|293|294|295|296|297|298|299|300|301|302|303|304|305|306|307|308|309|310|311|312|313|314|315|316|317|318|319|320|321|322|323|324|325|326|327|328|329|330|331|332|333|334|335|336|337|338|339|340|341|342|343|344|345|346|347|348|349|350|351|352|353|354|355|356|357|358|359|360)
                case $((wind_direction / 45)) in
                    0) wind_dir="–°" ;;
                    1) wind_dir="–°–í" ;;
                    2) wind_dir="–í" ;;
                    3) wind_dir="–Æ–í" ;;
                    4) wind_dir="–Æ" ;;
                    5) wind_dir="–Æ–ó" ;;
                    6) wind_dir="–ó" ;;
                    7) wind_dir="–°–ó" ;;
                    *) wind_dir="?" ;;
                esac
        ;;
        *)
            wind_dir="?"
        ;;
        esac
    else
        wind_dir="?"
    fi
    
    # –ü–æ–ª—É—á–µ–Ω–∏–µ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏ –∏ –¥–∞–≤–ª–µ–Ω–∏—è
    humidity=$(echo "$json" | jq -r '.hourly.relativehumidity_2m[0] // "?"')
    pressure=$(echo "$json" | jq -r '.current_weather.pressure // "?"')

    # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ JSON —Å—Ç—Ä–æ–∫–∏
    echo "{\"temp\":\"${temp}¬∞C\", \"icon\":\"${icon}\", \"description\":\"${desc}\", \"feels_like\":\"${temp}¬∞C\", \"wind_speed\":\"${wind_speed} –º/—Å\", \"wind_dir\":\"${wind_dir}\", \"humidity\":\"${humidity}%\", \"pressure\":\"${pressure} –≥–ü–∞\", \"city\":\"–ì–æ–º–µ–ª—å\", \"country\":\"BY\", \"last_update\":\"$(date '+%H:%M')\"}" > "$CACHE_FILE"
}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
if [ -f "$CACHE_FILE" ]; then
    CACHE_AGE=$(( $(date +%s) - $(stat -c %Y "$CACHE_FILE" 2>/dev/null || echo 0) ))
else
    CACHE_AGE=600  # –ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç, —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –∫—ç—à –ø—Ä–æ—Å—Ä–æ—á–µ–Ω
fi

# –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à, –µ—Å–ª–∏ –æ–Ω —Å—Ç–∞—Ä—à–µ 10 –º–∏–Ω—É—Ç –∏–ª–∏ —É–∫–∞–∑–∞–Ω –∞—Ä–≥—É–º–µ–Ω—Ç "update"
if [ $CACHE_AGE -ge $CACHE_TIME ] || [ "$1" = "update" ]; then
    fetch_weather
fi

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ JSON
get_value() {
    local field="$1"
    if [ -f "$CACHE_FILE" ]; then
        cat "$CACHE_FILE" | jq -r ".${field}" 2>/dev/null || echo "N/A"
    else
        echo "N/A"
    fi
}

# –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
case "$1" in
    "temp") get_value "temp" ;;
    "feels_like") get_value "feels_like" ;;
    "description") get_value "description" ;;
    "icon") get_value "icon" ;;
    "wind_speed") get_value "wind_speed" ;;
    "wind_dir") get_value "wind_dir" ;;
    "humidity") get_value "humidity" ;;
    "pressure") get_value "pressure" ;;
    "city") get_value "city" ;;
    "country") get_value "country" ;;
    "last_update") get_value "last_update" ;;
    "update") fetch_weather ;;
    *) 
        # –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω –∞—Ä–≥—É–º–µ–Ω—Ç, –≤—ã–≤–æ–¥–∏–º —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –∏ –∏–∫–æ–Ω–∫—É
        if [ -f "$CACHE_FILE" ]; then
            temp=$(get_value "temp")
            icon=$(get_value "icon")
            echo "${icon} ${temp}"
        else
            echo "üå§Ô∏è ?"
        fi
    ;;
esac
